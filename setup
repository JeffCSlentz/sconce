#!/bin/bash
# setup_sconce.sh: Deploy the sconce container as a system service.

SERVICE_NAME="sconce"
CONTAINER_FILE="${SERVICE_NAME}.container"
ROOTFUL_SYSTEMD_DIR=/usr/share/containers/systemd
#SYSTEMD_USER_DIR="${HOME}/.config/containers/systemd"
#SYSTEMD_PATH="${SYSTEMD_USER_DIR}/${CONTAINER_FILE}"

# Current working directory
CWD=$(pwd)

# Check if running with sudo/root privileges
if [ "$EUID" -ne 0 ]; then
   echo "Error: This script requires sudo privileges to write to $ROOTFUL_SYSTEMD_DIR"
   echo "Please run with: sudo $0"
   exit 1
fi

echo "Starting deployment of $SERVICE_NAME..."

# Check if container file exists
if [ ! -f "$CONTAINER_FILE" ]; then
   echo "Error: $CONTAINER_FILE not found in current directory."
   exit 1
fi

# Create systemd user directory if it doesn't exist
echo "Creating rootful systemd directory: $ROOTFUL_SYSTEMD_DIR"
mkdir -p "$ROOTFUL_SYSTEMD_DIR"

# Create torch-server directory in cwd
echo "Creating torch-server directory at: $CWD/torch-server"
mkdir -p "$CWD/torch-server"

# Ask if user has edited the container file
echo ""
read -p "Have you edited the sconce.container file to have `Volume=$CWD/torch-server:/app/torch-server`? (y/n): " -n 1 -r
echo ""
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
   echo "Please edit $CONTAINER_FILE before running setup."
   exit 1
fi

# Copy the .container file to the systemd user directory
echo "Copying $CONTAINER_FILE to $ROOTFUL_SYSTEMD_DIR"
cp "$CONTAINER_FILE" "$ROOTFUL_SYSTEMD_DIR"

# Reload systemd user daemon to detect the new service file
echo "Reloading systemd user daemon..."
systemctl daemon-reload

echo ""
echo "Deployment complete!"
echo "Start the service with: `systemctl start ${SERVICE_NAME}.service` or ./start"
echo "Check status with: `systemctl status ${SERVICE_NAME}.service`"